<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Αναφορά Κουίζ Εκπαιδευτικού</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 800px;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        .button-primary {
            transition: all 0.2s;
            background-color: #10b981; /* Emerald 500 */
        }
        .button-primary:hover {
            background-color: #059669; /* Emerald 600 */
            transform: translateY(-1px);
        }
        .point-item {
            border-left: 4px solid #10b981;
        }
        .quiz-image-container {
            width: 100%;
            height: auto;
            max-height: 250px; /* Limit height for display */
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .quiz-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .gemini-point {
            border-left: 4px solid #3b82f6; /* Blue border for Gemini Analysis */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Αναφορά Σημείων Συζήτησης από Κουίζ</h1>

        <!-- Loading & Status Messages -->
        <div id="status-message" class="hidden p-3 mb-4 rounded-lg text-sm text-center font-medium" role="alert"></div>

        <!-- Step 1: Filters -->
        <div id="step-1" class="card">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">1. Επιλογή Φίλτρων</h2>
            
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <!-- Age/Level Select -->
                <div class="flex flex-col">
                    <label for="age-select" class="text-sm font-medium text-gray-600 mb-1">Ηλικία/Επίπεδο</label>
                    <select id="age-select" class="p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="all" selected>Όλα τα Επίπεδα</option>
                        <option value="kid">Παιδί (Kid)</option>
                        <option value="teenager">Έφηβος (Teenager)</option>
                        <option value="adult">Ενήλικας (Adult)</option>
                    </select>
                </div>

                <!-- Theme Select -->
                <div class="flex flex-col">
                    <label for="theme-select" class="text-sm font-medium text-gray-600 mb-1">Θέμα Κουίζ</label>
                    <select id="theme-select" class="p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="all" selected>Όλα τα Θέματα</option>
                        <option value="art">Τέχνη (Art)</option>
                        <option value="antisocial">Κοινωνικά Θέματα (Antisocial)</option>
                        <option value="general">Γενικές Γνώσεις</option>
                    </select>
                </div>

                <!-- Date Filter - Now Selectable -->
                <div class="flex flex-col">
                    <label for="date-input" class="text-sm font-medium text-gray-600 mb-1">Ημερομηνία Αναφοράς</label>
                    <input id="date-input" type="date" class="p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
            </div>

            <button id="generate-report-btn" class="w-full mt-4 text-white font-semibold py-3 px-4 rounded-lg button-primary disabled:opacity-50">
                Δημιουργία Αναφοράς Κουίζ
            </button>
        </div>

        <!-- Step 2: Gemini Report Display -->
        <div id="step-2" class="card hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">2. Σημεία Συζήτησης για την Τάξη (Ανάλυση Gemini)</h2>
            
            <div id="report-summary" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800 hidden"></div>

            <div id="gemini-discussion-points" class="space-y-4">
                <!-- Gemini-generated points will be inserted here -->
                <p id="gemini-loading-message" class="text-center italic text-gray-500"></p>
            </div>
            
            <div id="no-data-message" class="hidden text-center p-6 bg-yellow-50 text-yellow-800 rounded-lg">
                Δεν βρέθηκαν κουίζ που να ταιριάζουν με τα κριτήρια για την επιλεγμένη ημερομηνία.
            </div>
        </div>
        
        <!-- Step 3: Detailed Quiz List (Reference) -->
        <div id="step-3-detailed-list" class="card hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">3. Λεπτομερής Λίστα Ατομικών Κουίζ (Αναφορά)</h2>
            <div id="individual-quizzes-list" class="space-y-4">
                <!-- Detailed individual quiz data will be inserted here -->
            </div>
        </div>
        
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configuration ---
        const GEMINI_API_KEY = "AIzaSyDn9Q0EROBRMQtJJgmPUuSV5AhdQCoeP1E"; 
        
        // Global Firebase/Auth/App Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCFslMC6avCrHcrLfxtzNv_yb362ZgajKY",
            authDomain: "way-to-school.firebaseapp.com",
            projectId: "way-to-school",
            storageBucket: "way-to-school.firebasestorage.app",
            messagingSenderId: "673870615354",
            appId: "1:673870615354:web:a7a77c9794c6478320b603",
            measurementId: "G-XBXDFRMKM3"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        setLogLevel('debug'); // Enable Firestore logging

        let app, db, auth, userId = null;

        // --- UI Elements ---
        const statusMessage = document.getElementById('status-message');
        const generateBtn = document.getElementById('generate-report-btn');
        const ageSelect = document.getElementById('age-select');
        const themeSelect = document.getElementById('theme-select');
        const dateInput = document.getElementById('date-input'); // Renamed from date-display
        const step2 = document.getElementById('step-2');
        const step3List = document.getElementById('step-3-detailed-list');
        const reportSummary = document.getElementById('report-summary');
        const geminiDiscussionPointsDiv = document.getElementById('gemini-discussion-points');
        const individualQuizzesListDiv = document.getElementById('individual-quizzes-list');
        const noDataMessage = document.getElementById('no-data-message');
        const geminiLoadingMessage = document.getElementById('gemini-loading-message');

        // --- Utility Functions (Greek Text) ---
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `p-3 mb-4 rounded-lg text-sm text-center font-medium`;
            statusMessage.classList.add('block');
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'loading') {
                statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
            } else { // info (default)
                statusMessage.classList.add('bg-blue-100', 'text-blue-800');
            }
        }
        
        function disableUI(loading) {
            generateBtn.disabled = loading;
            generateBtn.textContent = loading ? 'Αναζήτηση Δεδομένων...' : 'Δημιουργία Αναφοράς Κουίζ';
        }

        // Sets the default date input value to today (local time)
        function setDefaultDate() {
            const today = new Date();
            // Format to YYYY-MM-DD for date input
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(today.getDate()).padStart(2, '0');
            
            if (!dateInput.value) {
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            }
        }

        // --- Firebase Functions ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // Stop listening after the first state change
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                                showStatus(`Συνδεθήκατε ως Εκπαιδευτικός (User ID: ${userId}).`, 'success');
                            } catch (error) {
                                console.error("Custom Token Auth Error:", error);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                                showStatus(`Αποτυχία Custom Token. Συνδεθήκατε ανώνυμα (User ID: ${userId}).`, 'info');
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                            showStatus(`Συνδεθήκατε ανώνυμα (User ID: ${userId}).`, 'info');
                        }
                        resolve();
                    }, reject);
                });
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatus(`Σφάλμα εκκίνησης Firebase: ${error.message}`, 'error');
            }
        }
        
        // --- Gemini API Call for Discussion Points ---
        async function generateGeminiDiscussionPoints(quizzes, summary) {
            geminiLoadingMessage.textContent = 'Ανάλυση αποτελεσμάτων και δημιουργία εκπαιδευτικών σημείων συζήτησης με το Gemini...';
            geminiLoadingMessage.classList.remove('hidden');

            const model = "gemini-2.5-flash-preview-09-2025";
            const apiKey = GEMINI_API_KEY; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            // Prepare data for the prompt
            const quizDataList = quizzes.map(q => ({
                question: q.quizData.question,
                correctAnswer: q.quizData.correctAnswer,
                explanation: q.quizData.explanation,
                age: q.quizSettings.age,
                theme: q.quizSettings.theme,
                isCorrect: q.isCorrect,
                userAnswer: q.userAnswer // Can be null if not answered
            }));
            
            const context = {
                summary: summary,
                quizzes: quizDataList
            };

            const systemPrompt = `Ενεργείς ως έμπειρος εκπαιδευτικός και αναλυτής μαθησιακών αποτελεσμάτων. 
                                  Ο σκοπός σου είναι να μετατρέψεις τα δεδομένα των κουίζ που απαντήθηκαν σήμερα σε 3-4 σαφή, επαγγελματικά σημεία συζήτησης για την τάξη. 
                                  Χρησιμοποίησε τα Ελληνικά. 
                                  Κάθε σημείο πρέπει να είναι ένα μοναδικό "DiscussionPoint" που περιλαμβάνει: 
                                  1. Έναν σύντομο τίτλο. 
                                  2. Μια "PedagogicalFocus" (Εκπαιδευτική Εστίαση) που εξηγεί γιατί είναι σημαντικό αυτό το θέμα. 
                                  3. Μια "ClassActivity" (Δραστηριότητα Τάξης) - μια πρακτική άσκηση για την τάξη. 
                                  Παρέχετε την απάντηση σε αυστηρή μορφή JSON σύμφωνα με το schema.`;
                                  
            const userQuery = `Αναλύστε τα παρακάτω δεδομένα κουίζ, τα οποία περιλαμβάνουν την επιτυχία των μαθητών και τις ρυθμίσεις των κουίζ. Δημιουργήστε 3-4 σημεία συζήτησης για την τάξη, με βάση τα θέματα που φάνηκαν δύσκολα (χαμηλή επιτυχία) ή ενδιαφέροντα (μοναδικά θέματα/εικόνες) στα δεδομένα: \n\n${JSON.stringify(context, null, 2)}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: userQuery }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "discussionPoints": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "title": { "type": "STRING", "description": "Short, descriptive title for the discussion point." },
                                        "pedagogicalFocus": { "type": "STRING", "description": "Why this topic is important for the students to learn." },
                                        "classActivity": { "type": "STRING", "description": "A practical suggestion for a classroom activity related to the point." }
                                    },
                                    required: ["title", "pedagogicalFocus", "classActivity"]
                                }
                            }
                        },
                        required: ["discussionPoints"]
                    }
                }
            };
            
            let response = null;
            let attempts = 0;
            const maxRetries = 5;
            
            while (attempts < maxRetries) {
                attempts++;
                try {
                    const fetchResponse = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!fetchResponse.ok) {
                        const errorBody = await fetchResponse.text();
                        if (fetchResponse.status === 403) {
                            throw new Error(`Permission Denied (403): Invalid API Key.`);
                        }
                        throw new Error(`HTTP error! status: ${fetchResponse.status}. Body: ${errorBody}`);
                    }
                    
                    response = await fetchResponse.json();
                    break; // Success
                } catch (error) {
                    console.error(`Attempt ${attempts} failed:`, error);
                    if (attempts < maxRetries && error.message.indexOf('403') === -1) {
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        throw new Error(`Αποτυχία δημιουργίας σημείων συζήτησης μετά από ${attempts} προσπάθειες: ${error.message}`);
                    }
                }
            }
            
            geminiLoadingMessage.classList.add('hidden');

            if (response && response.candidates && response.candidates.length > 0 && response.candidates[0].content.parts[0].text) {
                try {
                    const jsonText = response.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(jsonText);
                    
                    if (parsedData.discussionPoints) {
                        return parsedData.discussionPoints;
                    } else {
                        throw new Error("Η απάντηση του Gemini δεν περιέχει τον πίνακα 'discussionPoints'.");
                    }

                } catch (e) {
                    console.error("Σφάλμα ανάλυσης JSON από το Gemini:", e);
                    throw new Error(`Σφάλμα ανάλυσης JSON: ${e.message}`);
                }
            } else {
                console.error("Σφάλμα απάντησης Gemini:", response);
                throw new Error("Κενή ή κακώς μορφοποιημένη απάντηση από το Gemini.");
            }
        }
        
        async function fetchAndGenerateReport() {
            if (!db || !userId) {
                showStatus("Περιμένετε την ολοκλήρωση της σύνδεσης στο Firebase.", 'error');
                return;
            }
            
            const selectedDateIso = dateInput.value;
            if (!selectedDateIso) {
                 showStatus("Παρακαλώ επιλέξτε μια ημερομηνία για την αναφορά.", 'error');
                 return;
            }

            disableUI(true);
            showStatus("Ανάκτηση δεδομένων κουίζ από το Firestore...", 'loading');

            geminiDiscussionPointsDiv.innerHTML = '';
            individualQuizzesListDiv.innerHTML = '';
            reportSummary.classList.add('hidden');
            noDataMessage.classList.add('hidden');
            step2.classList.remove('hidden');
            step3List.classList.remove('hidden');

            const selectedAge = ageSelect.value;
            const selectedTheme = themeSelect.value;
            const collectionPath = `artifacts/${appId}/users/${userId}/quizzes`;
            
            try {
                // Fetch all documents for the current user's quizzes
                const q = query(collection(db, collectionPath));
                const querySnapshot = await getDocs(q);
                
                const allDocuments = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ensure necessary fields exist before adding
                    if (data.quizSettings && data.quizData && data.timestamp) {
                        allDocuments.push(data);
                    }
                });

                // Client-side filtering
                const filteredQuizzes = allDocuments.filter(doc => {
                    // Firestore stores timestamps as ISO strings (e.g., '2025-11-24T12:00:00.000Z').
                    // We compare the YYYY-MM-DD prefix with the user-selected date.
                    const docDate = doc.timestamp ? doc.timestamp.substring(0, 10) : '';
                    
                    // Check 1: Date Match (using selected date)
                    const matchesDate = docDate === selectedDateIso;

                    // Check 2 & 3: Age and Theme Match
                    const matchesAge = selectedAge === 'all' || doc.quizSettings.age === selectedAge;
                    const matchesTheme = selectedTheme === 'all' || doc.quizSettings.theme === selectedTheme;
                    
                    return matchesDate && matchesAge && matchesTheme;
                });
                
                if (filteredQuizzes.length === 0) {
                    geminiDiscussionPointsDiv.innerHTML = '';
                    individualQuizzesListDiv.innerHTML = '';
                    noDataMessage.classList.remove('hidden');
                    step3List.classList.add('hidden');
                    showStatus(`Ολοκληρώθηκε. Δεν βρέθηκαν δεδομένα για τα επιλεγμένα φίλτρα στην ημερομηνία ${selectedDateIso}.`, 'info');
                    return;
                }
                
                // Process and Render Report
                await processAndRenderReport(filteredQuizzes, selectedAge, selectedTheme, selectedDateIso);

            } catch (e) {
                console.error("Error fetching documents:", e);
                showStatus(`Σφάλμα ανάκτησης δεδομένων: ${e.message}`, 'error');
                step2.classList.add('hidden');
                step3List.classList.add('hidden');
            } finally {
                disableUI(false);
            }
        }
        
        async function processAndRenderReport(quizzes, ageFilter, themeFilter, date) {
            
            let correctAnswersCount = 0;
            let totalQuizzesAnswered = 0;
            
            // Calculate summary statistics
            quizzes.forEach((quiz) => {
                if (quiz.userAnswer !== null && quiz.userAnswer !== undefined) {
                    totalQuizzesAnswered++;
                    if (quiz.isCorrect === true) {
                        correctAnswersCount++;
                    }
                }
            });

            const successRate = totalQuizzesAnswered > 0 ? ((correctAnswersCount / totalQuizzesAnswered) * 100).toFixed(1) : 'N/A';
            const summaryObject = {
                date: date,
                ageFilter: ageFilter,
                themeFilter: themeFilter,
                totalQuizzesToday: quizzes.length,
                totalAnswered: totalQuizzesAnswered,
                correctAnswers: correctAnswersCount,
                successRate: successRate
            };

            // 1. Render Summary
            reportSummary.innerHTML = `
                <p class="font-bold">Σύνοψη Αναφοράς:</p>
                <p><strong>Ημερομηνία Αναφοράς:</strong> ${date}</p>
                <p><strong>Φίλτρα:</strong> Επίπεδο: ${ageSelect.options[ageSelect.selectedIndex].text}, Θέμα: ${themeSelect.options[themeSelect.selectedIndex].text}</p>
                <p><strong>Συνολικά Κουίζ (βρέθηκαν):</strong> ${quizzes.length}</p>
                <p><strong>Ποσοστό Επιτυχίας (απαντημένα):</strong> ${successRate}% (${correctAnswersCount} / ${totalQuizzesAnswered})</p>
            `;
            reportSummary.classList.remove('hidden');

            // 2. Generate and Render Gemini Points
            try {
                const geminiPoints = await generateGeminiDiscussionPoints(quizzes, summaryObject);
                renderGeminiPoints(geminiPoints);
                showStatus("Η αναφορά δημιουργήθηκε με επιτυχία.", 'success');
            } catch (error) {
                console.error("Gemini Discussion Point Generation Failed:", error);
                geminiDiscussionPointsDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded-lg"><strong>Σφάλμα Gemini:</strong> Αποτυχία δημιουργίας σημείων συζήτησης. Εμφανίζονται μόνο ατομικά κουίζ. Λεπτομέρειες: ${error.message}</div>`;
                showStatus(`Αποτυχία δημιουργίας σημείων συζήτησης: ${error.message}.`, 'error');
            }
            
            // 3. Render Individual Quizzes List (for detailed reference)
            renderIndividualQuizzes(quizzes);
        }
        
        function renderGeminiPoints(points) {
            geminiDiscussionPointsDiv.innerHTML = points.map((p, index) => `
                <div class="gemini-point p-4 bg-blue-50 rounded-lg shadow-sm border-blue-300">
                    <p class="font-bold text-xl text-blue-800 mb-2">Σημείο ${index + 1}: ${p.title}</p>
                    
                    <div class="mt-2 text-sm">
                        <p class="font-semibold text-gray-700">Εκπαιδευτική Εστίαση:</p>
                        <p class="text-gray-600 italic">${p.pedagogicalFocus}</p>
                    </div>

                    <div class="mt-3">
                        <p class="font-semibold text-sm text-indigo-700">Προτεινόμενη Δραστηριότητα Τάξης:</p>
                        <p class="text-gray-600">${p.classActivity}</p>
                    </div>
                </div>
            `).join('');
        }
        
        function renderIndividualQuizzes(quizzes) {
            individualQuizzesListDiv.innerHTML = quizzes.map((quiz, index) => `
                <div class="point-item p-4 bg-gray-50 rounded-lg shadow-sm border-green-300">
                    <p class="font-bold text-lg text-gray-700 mb-2">Κουίζ ${index + 1}: ${quiz.quizData.question}</p>
                    
                    <!-- Image Display Area -->
                    <div class="quiz-image-container">
                        ${quiz.imageThumbnail ? `
                            <img src="${quiz.imageThumbnail}" alt="Εικόνα Κουίζ ${index + 1}" class="quiz-image" 
                                 onerror="this.onerror=null; this.src='https://placehold.co/400x250/f3f4f6/9ca3af?text=Δεν+Βρέθηκε+Εικόνα';">
                        ` : `
                            <p class="text-gray-500 italic">Δεν υπάρχει εικόνα για αυτό το κουίζ.</p>
                        `}
                    </div>
                    
                    <p class="text-sm">
                        <span class="font-semibold text-green-700">Σωστή Απάντηση:</span> ${quiz.quizData.correctAnswer}
                    </p>
                    <p class="text-sm italic text-gray-600 mt-1">
                        <span class="font-semibold">Επεξήγηση:</span> ${quiz.quizData.explanation}
                    </p>
                    <p class="text-xs text-gray-500 mt-2">
                        Ρυθμίσεις: Επίπεδο: ${quiz.quizSettings.age}, Θέμα: ${quiz.quizSettings.theme}
                    </p>
                    ${quiz.userAnswer ? `
                        <div class="mt-2 text-xs p-1 rounded inline-block ${quiz.isCorrect ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            Απάντηση Χρήστη: ${quiz.userAnswer} (${quiz.isCorrect ? 'Σωστό' : 'Λάθος'})
                        </div>
                    ` : '<div class="mt-2 text-xs p-1 rounded inline-block bg-yellow-100 text-yellow-700">Δεν απαντήθηκε</div>'}
                </div>
            `).join('');
        }

        // --- Event Listeners and Initial Setup ---
        generateBtn.addEventListener('click', fetchAndGenerateReport);

        window.onload = () => {
            // 1. Initialize Firebase and Auth
            initializeFirebase();
            
            // 2. Set the current date as default value
            setDefaultDate();
        };

    </script>

</body>
</html>
