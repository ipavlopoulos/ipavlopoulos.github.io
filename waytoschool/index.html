<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Δημιουργία Κουίζ από Εικόνα</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 700px;
        }
        .step-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        .button-primary {
            transition: all 0.2s;
            background-color: #10b981; /* Emerald 500 */
        }
        .button-primary:hover {
            background-color: #059669; /* Emerald 600 */
            transform: translateY(-1px);
        }
        .button-quiz {
            transition: all 0.2s;
        }
        .button-quiz:hover:not(.disabled) {
            background-color: #e0f2f1; /* Teal 50 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Δημιουργός Κουίζ με ΑΙ</h1>

        <!-- Loading & Status Messages -->
        <div id="status-message" class="hidden p-3 mb-4 rounded-lg text-sm text-center font-medium" role="alert"></div>

        <!-- Step 1: Image Capture and Settings -->
        <div id="step-1" class="step-card">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">1. Ρυθμίσεις και Φωτογραφία</h2>
            
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Settings -->
                <div class="space-y-4">
                    <div class="flex flex-col">
                        <label for="age-select" class="text-sm font-medium text-gray-600 mb-1">Ηλικία/Επίπεδο</label>
                        <select id="age-select" class="p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="kid">Παιδί (Kid)</option>
                            <option value="teenager">Έφηβος (Teenager)</option>
                            <option value="adult" selected>Ενήλικας (Adult)</option>
                        </select>
                    </div>

                    <div class="flex flex-col">
                        <label for="theme-select" class="text-sm font-medium text-gray-600 mb-1">Θέμα Κουίζ</label>
                        <select id="theme-select" class="p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="art">Τέχνη (Art)</option>
                            <option value="antisocial">Κοινωνικά Θέματα (Antisocial)</option>
                            <option value="general" selected>Γενικές Γνώσεις</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-col">
                        <label for="language-input" class="text-sm font-medium text-gray-600 mb-1">Γλώσσα</label>
                        <input id="language-input" type="text" value="Greek" disabled class="p-2 border border-gray-300 bg-gray-100 rounded-lg text-gray-500">
                    </div>

                    <div id="location-display" class="p-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                        <p><strong>Τοποθεσία:</strong> Αναμονή...</p>
                    </div>
                </div>

                <!-- Image Input -->
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <label for="image-input" class="cursor-pointer text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.153 4h3.694a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <p class="mt-2 text-sm text-gray-600 font-medium">Πατήστε για Φωτογραφία / Επιλογή Αρχείου</p>
                    </label>
                    <input type="file" id="image-input" accept="image/*" capture="environment" class="hidden">
                    <img id="image-preview" class="mt-4 max-w-full max-h-48 rounded-lg shadow-md hidden" alt="Προεπισκόπηση Εικόνας">
                </div>
            </div>

            <button id="generate-quiz-btn" class="w-full mt-4 text-white font-semibold py-3 px-4 rounded-lg button-primary disabled:opacity-50" disabled>
                Δημιουργία Κουίζ
            </button>
        </div>

        <!-- Step 2: Quiz Display -->
        <div id="step-2" class="step-card hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">2. Απάντησε στο Κουίζ</h2>
            
            <p id="quiz-question" class="text-lg font-medium text-gray-800 mb-6"></p>

            <div id="quiz-options" class="space-y-3">
                <!-- Options will be inserted here -->
            </div>
            
            <div id="quiz-feedback" class="mt-6 p-4 rounded-lg text-sm font-medium hidden">
                <p id="feedback-result" class="font-bold mb-1"></p>
                <p id="feedback-explanation"></p>
            </div>

            <button id="show-answer-btn" class="mt-6 w-full text-white font-semibold py-3 px-4 rounded-lg bg-indigo-500 hover:bg-indigo-600 transition disabled:opacity-50 hidden" disabled>
                Εμφάνιση Απάντησης (Εάν δεν απαντηθεί)
            </button>
        </div>

        <!-- Step 3: Firebase Data Display -->
        <div id="step-3" class="step-card hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">3. Δεδομένα που Αποθηκεύτηκαν</h2>
            <div id="firestore-data" class="text-sm space-y-2 p-3 bg-gray-50 rounded-lg border">
                <!-- Data will be inserted here -->
            </div>
        </div>
        
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Firebase/Auth/App Variables ---
        // Ensure to use the global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCFslMC6avCrHcrLfxtzNv_yb362ZgajKY",
            authDomain: "way-to-school.firebaseapp.com",
            projectId: "way-to-school",
            storageBucket: "way-to-school.firebasestorage.app",
            messagingSenderId: "673870615354",
            appId: "1:673870615354:web:a7a77c9794c6478320b603",
            measurementId: "G-XBXDFRMKM3"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        setLogLevel('debug'); // Enable Firestore logging

        let app, db, auth, userId = null;
        let originalImageBase64 = null;
        let downscaledImageBase64 = null;
        let currentQuizData = null;
        let userLocation = { lat: null, lon: null };
        let currentDocRef = null; // To store the reference of the quiz document

        // --- UI Elements ---
        const statusMessage = document.getElementById('status-message');
        const generateBtn = document.getElementById('generate-quiz-btn');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const quizOptionsDiv = document.getElementById('quiz-options');
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');
        const locationDisplay = document.getElementById('location-display');
        const quizFeedback = document.getElementById('quiz-feedback');
        const quizQuestion = document.getElementById('quiz-question');
        const firestoreDataDisplay = document.getElementById('firestore-data');

        // --- Utility Functions (Greek Text) ---
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `p-3 mb-4 rounded-lg text-sm text-center font-medium`;
            statusMessage.classList.add('block');
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'loading') {
                statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
            } else { // info (default)
                statusMessage.classList.add('bg-blue-100', 'text-blue-800');
            }
        }
        
        function disableUI(loading) {
            generateBtn.disabled = loading || !downscaledImageBase64;
            generateBtn.textContent = loading ? 'Δημιουργία... (Περιμένετε)' : 'Δημιουργία Κουίζ';
        }

        // --- Geolocation ---
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation.lat = position.coords.latitude;
                        userLocation.lon = position.coords.longitude;
                        locationDisplay.innerHTML = `<p><strong>Τοποθεσία:</strong> ${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)} (Επιτυχής λήψη)</p>`;
                    },
                    (error) => {
                        console.error("Geolocation Error:", error);
                        locationDisplay.innerHTML = `<p><strong>Τοποθεσία:</strong> Δεν ήταν δυνατή η λήψη Lat/Lon. (${error.message})</p>`;
                    },
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
                );
            } else {
                locationDisplay.innerHTML = `<p><strong>Τοποθεσία:</strong> Η συσκευή δεν υποστηρίζει geolocation.</p>`;
            }
        }

        // --- Image Resizing/Downscaling ---
        function resizeImage(base64Image, maxWidth = 400, maxHeight = 400) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
        
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
        
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert canvas content to JPEG Base64, lower quality for smaller size
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                    resolve(dataUrl);
                };
                img.src = base64Image;
            });
        }
        
        // --- Firebase Functions ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // Stop listening after the first state change
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                                showStatus(`Συνδεθήκατε με επιτυχία (User ID: ${userId}).`, 'success');
                            } catch (error) {
                                console.error("Custom Token Auth Error:", error);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                                showStatus(`Αποτυχία Custom Token. Συνδεθήκατε ανώνυμα (User ID: ${userId}).`, 'info');
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                            showStatus(`Συνδεθήκατε ανώνυμα (User ID: ${userId}).`, 'info');
                        }
                        resolve();
                    }, reject);
                });
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatus(`Σφάλμα εκκίνησης Firebase: ${error.message}`, 'error');
            }
        }

        async function saveQuizData(step) {
            if (!db || !userId || !downscaledImageBase64) return;
            
            const age = document.getElementById('age-select').value;
            const theme = document.getElementById('theme-select').value;
            const language = document.getElementById('language-input').value;
            const collectionPath = `artifacts/${appId}/users/${userId}/quizzes`;
            
            const dataToSave = {
                timestamp: new Date().toISOString(),
                userId: userId,
                quizSettings: { age, language, theme },
                imageThumbnail: downscaledImageBase64,
                latitude: userLocation.lat,
                longitude: userLocation.lon,
                quizData: currentQuizData, // This will be null on first save
                userAnswer: null,
                isCorrect: null
            };

            try {
                if (step === 'generation') {
                    // Initial save: Only settings and image/location
                    const docRef = await addDoc(collection(db, collectionPath), {
                        ...dataToSave,
                        quizData: currentQuizData // Now quizData is available
                    });
                    currentDocRef = docRef;
                    console.log("Document written with ID: ", docRef.id);
                    showStatus("Κουίζ δημιουργήθηκε και αποθηκεύτηκε στο Firestore.", 'success');
                    displayFirestoreData(docRef.id, dataToSave);

                } else if (step === 'answer' && currentDocRef) {
                    // Update save: Add user's answer and result
                    const selectedOption = document.querySelector('button[data-selected="true"]');
                    const predictedAnswer = selectedOption ? selectedOption.textContent.trim() : 'Δεν απαντήθηκε';
                    const isCorrect = predictedAnswer === currentQuizData.correctAnswer;

                    await setDoc(currentDocRef, {
                        userAnswer: predictedAnswer,
                        isCorrect: isCorrect
                    }, { merge: true });

                    const finalData = { ...dataToSave, userAnswer: predictedAnswer, isCorrect: isCorrect };
                    displayFirestoreData(currentDocRef.id, finalData);
                    showStatus(`Η απάντησή σας αποθηκεύτηκε.`, 'success');
                }
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showStatus(`Σφάλμα αποθήκευσης στο Firestore: ${e.message}`, 'error');
            }
        }
        
        function displayFirestoreData(docId, data) {
            const quizInfo = data.quizData ? `
                <p><strong>Ερώτηση:</strong> ${data.quizData.question}</p>
                <p><strong>Σωστή Απάντηση:</strong> ${data.quizData.correctAnswer}</p>
                ${data.userAnswer ? `<p><strong>Απάντηση Χρήστη:</strong> ${data.userAnswer}</p><p><strong>Αποτέλεσμα:</strong> ${data.isCorrect ? 'ΣΩΣΤΟ' : 'ΛΑΘΟΣ'}</p>` : '<p><strong>Απάντηση Χρήστη:</strong> Δεν έχει απαντηθεί ακόμη</p>'}
            ` : '<p>Το κουίζ δεν έχει δημιουργηθεί ακόμα.</p>';
            
            firestoreDataDisplay.innerHTML = `
                <p class="font-bold text-base">ID Εγγράφου: ${docId}</p>
                <p><strong>User ID:</strong> ${data.userId}</p>
                <p><strong>Lat/Lon:</strong> ${data.latitude ? `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}` : 'N/A'}</p>
                <p><strong>Thumbnail (Base64):</strong> ${data.imageThumbnail.substring(0, 50)}...</p>
                <hr class="my-2 border-gray-200">
                ${quizInfo}
            `;
            step3.classList.remove('hidden');
        }


        // --- Gemini API Call ---
        async function generateQuiz() {
            if (!downscaledImageBase64 || !userId) return;

            disableUI(true);
            showStatus("Αποστολή εικόνας στο Gemini για δημιουργία κουίζ...", 'loading');
            
            const age = document.getElementById('age-select').value;
            const theme = document.getElementById('theme-select').value;
            const language = document.getElementById('language-input').value;
            
            const model = "gemini-2.5-flash-preview-09-2025";
            const apiKey = "AIzaSyBwbj_B_tiSNOLsWMp2kJUgZsaWmqkoKPQ";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const mimeType = downscaledImageBase64.match(/data:(.*?);/)?.[1] || 'image/jpeg';
            const base64Data = downscaledImageBase64.split(',')[1];
            
            const systemPrompt = `Ενεργείς ως εκπαιδευτικός και δημιουργείς ένα κουίζ πολλαπλής επιλογής (4 επιλογές) με βάση την εικόνα που παρέχεται. 
                                  Το κουίζ πρέπει να είναι προσαρμοσμένο για έναν ${age === 'kid' ? 'παιδί' : (age === 'teenager' ? 'έφηβο' : 'ενήλικα')} και να επικεντρώνεται στο θέμα: ${theme}. 
                                  Η γλώσσα της απάντησης πρέπει να είναι αποκλειστικά ${language === 'Greek' ? 'Ελληνικά' : language}.
                                  Παρέχετε την απάντηση σε αυστηρή μορφή JSON σύμφωνα με το schema.`;
                                  
            const userQuery = `Δημιουργήστε ένα κουίζ (ερώτηση, 4 επιλογές, σωστή απάντηση, εξήγηση) για την εικόνα.`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Data
                            }
                        }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "question": { "type": "STRING", "description": "The quiz question." },
                            "options": {
                                "type": "ARRAY",
                                "description": "Four options for the quiz.",
                                "items": { "type": "STRING" }
                            },
                            "correctAnswer": { "type": "STRING", "description": "The exact text of the correct option." },
                            "explanation": { "type": "STRING", "description": "A detailed explanation for the correct answer." }
                        },
                        required: ["question", "options", "correctAnswer", "explanation"]
                    }
                }
            };

            let response = null;
            let attempts = 0;
            const maxRetries = 5;
            
            while (attempts < maxRetries) {
                attempts++;
                try {
                    const fetchResponse = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!fetchResponse.ok) throw new Error(`HTTP error! status: ${fetchResponse.status}`);
                    
                    response = await fetchResponse.json();
                    break; // Success
                } catch (error) {
                    console.error(`Attempt ${attempts} failed:`, error);
                    if (attempts < maxRetries) {
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        throw new Error(`Failed to fetch from Gemini API after ${maxRetries} attempts.`);
                    }
                }
            }

            disableUI(false);
            
            if (response && response.candidates && response.candidates.length > 0 && response.candidates[0].content.parts[0].text) {
                try {
                    const jsonText = response.candidates[0].content.parts[0].text;
                    currentQuizData = JSON.parse(jsonText);
                    
                    // Proceed to Step 2
                    renderQuiz(currentQuizData);
                    await saveQuizData('generation'); // Save generated quiz data to Firestore

                } catch (e) {
                    console.error("JSON Parsing Error:", e);
                    showStatus(`Σφάλμα ανάλυσης JSON από το Gemini: ${e.message}. Δοκιμάστε ξανά.`, 'error');
                }
            } else {
                showStatus("Αποτυχία λήψης απάντησης από το Gemini. Ελέγξτε την κονσόλα.", 'error');
                console.error("Gemini Response Error:", response);
            }
        }
        
        // --- Quiz Rendering and Interaction ---
        function renderQuiz(data) {
            quizQuestion.textContent = data.question;
            quizOptionsDiv.innerHTML = '';
            quizFeedback.classList.add('hidden');
            
            data.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'w-full text-left p-3 border border-gray-200 rounded-lg button-quiz hover:bg-gray-100 transition';
                button.setAttribute('data-index', index);
                button.onclick = () => handleAnswer(button, option);
                quizOptionsDiv.appendChild(button);
            });
            
            step2.classList.remove('hidden');
        }

        function handleAnswer(selectedButton, selectedOption) {
            if (document.querySelector('.button-quiz.disabled')) return; // Already answered

            const isCorrect = selectedOption === currentQuizData.correctAnswer;
            
            // Disable all buttons and mark them as answered
            document.querySelectorAll('.button-quiz').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled', 'cursor-not-allowed');
                
                // Identify correct answer
                if (btn.textContent.trim() === currentQuizData.correctAnswer) {
                    btn.classList.add('bg-green-100', 'border-green-500', 'font-semibold');
                }
                
                // Mark user's selection
                if (btn === selectedButton) {
                    btn.setAttribute('data-selected', 'true');
                    if (isCorrect) {
                        btn.classList.remove('bg-gray-100', 'border-gray-200');
                        btn.classList.add('bg-green-500', 'text-white', 'border-green-700');
                    } else {
                        btn.classList.remove('bg-gray-100', 'border-gray-200');
                        btn.classList.add('bg-red-500', 'text-white', 'border-red-700');
                    }
                }
            });

            // Show feedback
            quizFeedback.classList.remove('hidden');
            quizFeedback.classList.add(isCorrect ? 'bg-green-100/70' : 'bg-red-100/70', isCorrect ? 'text-green-800' : 'text-red-800');
            document.getElementById('feedback-result').textContent = isCorrect ? 'ΣΩΣΤΗ ΑΠΑΝΤΗΣΗ!' : 'ΛΑΘΟΣ ΑΠΑΝΤΗΣΗ.';
            document.getElementById('feedback-explanation').innerHTML = `
                <span class="font-bold">Σωστή Απάντηση:</span> ${currentQuizData.correctAnswer}<br>
                <span class="font-bold">Επεξήγηση:</span> ${currentQuizData.explanation}
            `;
            
            // Save the result to Firestore
            saveQuizData('answer');
        }

        // --- Event Listeners and Initial Setup ---
        
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    originalImageBase64 = e.target.result;
                    imagePreview.src = originalImageBase64;
                    imagePreview.classList.remove('hidden');

                    // Downscale the image for API and Firestore storage
                    downscaledImageBase64 = await resizeImage(originalImageBase64);
                    
                    // Enable button
                    generateBtn.disabled = false;
                    showStatus("Η εικόνα φορτώθηκε. Είστε έτοιμοι για δημιουργία κουίζ.", 'info');
                };
                reader.readAsDataURL(file);
            }
        });

        generateBtn.addEventListener('click', generateQuiz);

        window.onload = () => {
            // 1. Initialize Firebase and Auth
            initializeFirebase();
            
            // 2. Get Geolocation (non-blocking)
            getLocation();
        };

    </script>

</body>
</html>
