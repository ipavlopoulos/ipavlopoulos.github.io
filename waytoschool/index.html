<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Δημιουργία Κουίζ από Εικόνα</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container { max-width: 700px; }
        .step-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        .button-primary {
            transition: all 0.2s;
            background-color: #10b981;
        }
        .button-primary:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }
    </style>
</head>

<body class="p-4 md:p-8">
<div class="container mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Δημιουργός Κουίζ με ΑΙ</h1>

    <div id="status-message" class="hidden p-3 mb-4 rounded-lg text-sm text-center font-medium"></div>

    <!-- STEP 1 -->
    <div id="step-1" class="step-card">
        <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">1. Ρυθμίσεις και Φωτογραφία</h2>

        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="space-y-4">
                <div>
                    <label class="text-sm">Ηλικία</label>
                    <select id="age-select" class="p-2 border rounded-lg w-full">
                        <option value="kid">Παιδί</option>
                        <option value="teenager">Έφηβος</option>
                        <option value="adult" selected>Ενήλικας</option>
                    </select>
                </div>

                <div>
                    <label class="text-sm">Θέμα</label>
                    <select id="theme-select" class="p-2 border rounded-lg w-full">
                        <option value="art">Τέχνη</option>
                        <option value="antisocial">Κοινωνικά</option>
                        <option value="general" selected>Γενικά</option>
                    </select>
                </div>

                <div>
                    <label class="text-sm">Γλώσσα</label>
                    <input id="language-input" class="p-2 border rounded-lg w-full bg-gray-100" value="Greek" disabled>
                </div>

                <div id="location-display" class="p-2 bg-blue-50 border rounded-lg text-sm">
                    <strong>Τοποθεσία:</strong> Αναμονή...
                </div>
            </div>

            <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-4">
                <label for="image-input" class="cursor-pointer text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M3 9a2 2 0 012-2h..."></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">Πατήστε για Φωτογραφία</p>
                </label>
                <input type="file" id="image-input" accept="image/*" capture="environment" class="hidden">
                <img id="image-preview" class="mt-4 max-w-full max-h-48 rounded-lg shadow-md hidden">
            </div>
        </div>

        <button id="generate-quiz-btn"
                class="w-full mt-4 text-white font-semibold py-3 px-4 rounded-lg button-primary disabled:opacity-50"
                disabled>
            Δημιουργία Κουίζ
        </button>
    </div>

    <!-- STEP 2 -->
    <div id="step-2" class="step-card hidden">
        <h2 class="text-xl font-semibold mb-4 border-b pb-2">2. Απάντησε στο Κουίζ</h2>
        <p id="quiz-question" class="text-lg font-medium mb-6"></p>
        <div id="quiz-options" class="space-y-3"></div>

        <div id="quiz-feedback"
             class="mt-6 p-4 rounded-lg text-sm font-medium hidden bg-gray-50 border">
            <p id="feedback-result" class="font-bold mb-1"></p>
            <p id="feedback-explanation"></p>
        </div>
    </div>

    <!-- STEP 3 -->
    <div id="step-3" class="step-card hidden">
        <h2 class="text-xl font-semibold mb-4 border-b pb-2">3. Δεδομένα</h2>
        <div id="firestore-data" class="text-sm space-y-2 p-3 bg-gray-50 rounded-lg border"></div>
    </div>
</div>

<!-- JAVASCRIPT -->
<script type="module">

    /* ---------- IMPORTS ---------- */
    import {
        initializeApp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        collection,
        addDoc,
        setDoc,
        doc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


    /* ---------- GLOBALS ---------- */
    let app, db, auth, userId = null;
    let currentQuizData = null;
    let originalImageBase64 = null;
    let downscaledImageBase64 = null;
    let currentDocRef = null;
    let userLocation = {lat: null, lon: null};

    const statusMessage = document.getElementById('status-message');
    const generateBtn = document.getElementById('generate-quiz-btn');
    const quizOptionsDiv = document.getElementById('quiz-options');
    const quizFeedback = document.getElementById('quiz-feedback');
    const quizQuestion = document.getElementById('quiz-question');
    const firestoreDataDisplay = document.getElementById('firestore-data');


    /* ---------- STATUS UI ---------- */
    function showStatus(msg, type = "info") {
        statusMessage.textContent = msg;
        statusMessage.classList.remove("hidden");
        statusMessage.className =
            "p-3 mb-4 rounded-lg text-center text-sm font-medium";

        const classes = {
            error: "bg-red-100 text-red-800",
            success: "bg-green-100 text-green-800",
            loading: "bg-yellow-100 text-yellow-800",
            info: "bg-blue-100 text-blue-800"
        };

        statusMessage.classList.add(classes[type] || classes.info);
    }

    function disableUI(loading) {
        generateBtn.disabled = loading || !downscaledImageBase64;
        generateBtn.textContent = loading ? "Δημιουργία..." : "Δημιουργία Κουίζ";
    }


    /* ---------- LOCATION ---------- */
    function getLocation() {
        if (!navigator.geolocation) return;

        navigator.geolocation.getCurrentPosition(
            pos => {
                userLocation.lat = pos.coords.latitude;
                userLocation.lon = pos.coords.longitude;
                document.getElementById("location-display").innerHTML =
                    `<strong>Τοποθεσία:</strong> ${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
            },
            err => {
                document.getElementById("location-display").innerHTML =
                    `<strong>Τοποθεσία:</strong> Δεν βρέθηκε (${err.message})`;
            }
        );
    }
    getLocation();


    /* ---------- IMAGE HANDLING ---------- */
    document.getElementById("image-input").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async () => {
            originalImageBase64 = reader.result;

            // preview
            const imgPrev = document.getElementById("image-preview");
            imgPrev.src = originalImageBase64;
            imgPrev.classList.remove("hidden");

            // resize
            downscaledImageBase64 = await resizeImage(originalImageBase64);
            generateBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    });


    function resizeImage(base64, maxW = 400, maxH = 400) {
        return new Promise(resolve => {
            let img = new Image();
            img.onload = () => {
                let w = img.width, h = img.height;
                if (w > h && w > maxW) { h *= maxW / w; w = maxW; }
                else if (h > maxH) { w *= maxH / h; h = maxH; }

                const canvas = document.createElement("canvas");
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL("image/jpeg", 0.7));
            };
            img.src = base64;
        });
    }


    /* ---------- FIREBASE INIT ---------- */
    async function initFirebase() {

        const firebaseConfig = {
            apiKey: "AIzaSyCFslMC6avCrHcrLfxtzNv_yb362ZgajKY",
            authDomain: "way-to-school.firebaseapp.com",
            projectId: "way-to-school",
            storageBucket: "way-to-school.firebasestorage.app",
            messagingSenderId: "673870615354",
            appId: "1:673870615354:web:a7a77c9794c6478320b603",
            measurementId: "G-XBXDFRMKM3"
        };

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        await signInAnonymously(auth);
        userId = auth.currentUser.uid;
        showStatus(`Συνδεθήκατε ανώνυμα (User: ${userId})`, "info");
    }
    initFirebase();


    /* ---------- QUIZ GENERATION (Gemini) ---------- */
    document.getElementById("generate-quiz-btn").addEventListener("click", generateQuiz);

    async function generateQuiz() {

        disableUI(true);
        showStatus("Αποστολή εικόνας στο Gemini...", "loading");

        const age = document.getElementById("age-select").value;
        const theme = document.getElementById("theme-select").value;

        const model = "gemini-2.5-flash-preview-09-2025";
        const apiKey = "AIzaSyBh7x2Y6ljBEWPyQf7mb80yAa9wMqCouzc";

        const payload = {
            contents: [{
                parts: [
                    { text: getSystemPrompt(age, theme) },
                    {
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: downscaledImageBase64.split(",")[1]
                        }
                    }
                ]
            }]
        };

        try {
            const res = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
                {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(payload)
                }
            );

            const data = await res.json();
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";

            currentQuizData = JSON.parse(text);

            renderQuiz();
            await saveQuiz("generation");

            showStatus("Το κουίζ δημιουργήθηκε!", "success");

        } catch (err) {
            showStatus("Σφάλμα κατά τη δημιουργία κουίζ: " + err.message, "error");
        }

        disableUI(false);
    }


    function getSystemPrompt(age, theme) {
        return `
Δώσε JSON μόνο.
Φτιάξε κουίζ πολλαπλής επιλογής (4 επιλογές) βασισμένο στην εικόνα.
Περίγραμμα JSON:
{
 "question": "...",
 "options": ["A","B","C","D"],
 "correctAnswer": "...",
 "explanation": "..."
}

Κατηγορία ηλικίας: ${age}
Θεματική: ${theme}

Απάντησε ΜΟΝΟ με JSON.
`;
    }


    /* ---------- QUIZ UI ---------- */
    function renderQuiz() {
        document.getElementById("step-2").classList.remove("hidden");

        quizQuestion.textContent = currentQuizData.question;
        quizOptionsDiv.innerHTML = "";

        currentQuizData.options.forEach(opt => {
            let btn = document.createElement("button");
            btn.textContent = opt;
            btn.className =
                "block w-full p-3 border rounded-lg bg-white hover:bg-gray-50 text-left";
            btn.onclick = () => evaluateAnswer(opt);
            quizOptionsDiv.appendChild(btn);
        });
    }


    async function evaluateAnswer(userAnswer) {
        const correct = userAnswer === currentQuizData.correctAnswer;

        quizFeedback.classList.remove("hidden");
        document.getElementById("feedback-result").textContent =
            correct ? "Σωστό!" : "Λάθος!";
        document.getElementById("feedback-result").className =
            correct ? "text-green-700 font-bold" : "text-red-700 font-bold";
        document.getElementById("feedback-explanation").textContent =
            currentQuizData.explanation;

        await saveQuiz("answer", userAnswer);
    }


    /* ---------- FIREBASE SAVE ---------- */
    async function saveQuiz(step, answer = null) {

        const collectionPath = `artifacts/web/users/${userId}/quizzes`;
        const data = {
            timestamp: new Date().toISOString(),
            userId,
            imageThumbnail: downscaledImageBase64,
            latitude: userLocation.lat,
            longitude: userLocation.lon,
        };

        if (step === "generation") {
            data.quizData = currentQuizData;
            currentDocRef = await addDoc(collection(db, collectionPath), data);
            displayFirestore(currentDocRef.id, data);
        }

        if (step === "answer") {
            await setDoc(currentDocRef, {
                userAnswer: answer,
                isCorrect: answer === currentQuizData.correctAnswer
            }, {merge: true});

            data.userAnswer = answer;
            data.isCorrect = answer === currentQuizData.correctAnswer;
            displayFirestore(currentDocRef.id, data);
        }
    }


    function displayFirestore(id, data) {
        document.getElementById("step-3").classList.remove("hidden");

        firestoreDataDisplay.innerHTML = `
        <p><strong>ID:</strong> ${id}</p>
        <p><strong>User:</strong> ${data.userId}</p>
        <p><strong>Lat/Lon:</strong> ${data.latitude}, ${data.longitude}</p>
        ${data.quizData ? `
            <p><strong>Ερώτηση:</strong> ${data.quizData.question}</p>
            <p><strong>Σωστή:</strong> ${data.quizData.correctAnswer}</p>
        ` : ``}
        ${data.userAnswer ? `
            <p><strong>Απάντηση:</strong> ${data.userAnswer}</p>
            <p><strong>Αποτέλεσμα:</strong> ${data.isCorrect ? "Σωστό" : "Λάθος"}</p>
        ` : ``}
        `;
    }

</script>

</body>
</html>
